# 数字地理学（区域灵气网络）

这是一个基于 **图论（Graph Theory）** 和 **元胞自动机（Cellular Automata）** 的动态修仙地理生态系统，其基础理论来自[**元炁守恒**](./zhenqishouheng.md)。

该系统的核心在于：**五行驱动变化，灵气反映总量，灵脉决定稳态。**  

以下是详细的设计方案：

## 第一部分：地区数据结构 (Data Model)

每个地区节点（Zone, $Z_i$）包含以下核心状态数据：

1. 五行属性向量 ($E_i$)：

   $$E_i = [w, f, e, m, a]$$

   分别代表 木(Wood), 火(Fire), 土(Earth), 金(Metal), 水(Aqua/Water) 的当前强度值。  
   * *输入源*：玩家行为（如在$Z_1$炼丹增加火属性）、法宝光环、城镇建设、妖兽栖息。  
2. 灵气浓度 ($N_i$)：  
   派生属性，由五行向量计算得出。  
3. 羁绊状态 ($L_{ij}$)：  
   记录该地区与相邻地区（如 $Z_1$ 和 $Z_2$）之间的连接强度，用于计算“灵脉”。

## 第二部分：灵气浓度公式 ($N$)

灵气不仅仅是五行的简单加和，**“相生”**（五行流转顺畅）会带来额外的灵气增幅， **“相克”**（五行流转不畅）会带来额外的灵气损耗。  
设计公式如下：

$$N_i = \underbrace{\sum_{k \in \{w,f,e,m,a\}} E_{i,k}}_{\text{基础灵蕴}} + \underbrace{\mu \cdot \sum (E_{i,k} \times E_{i, next_g(k)})}_{\text{相生共鸣增益}} - \underbrace{\mu \cdot \sum (E_{i,k} \times E_{i, next_l(k)})}_{\text{相克共鸣损耗}}$$

* **说明**：  
  * 第一部分是五行强度的总和。  
  * 第二部分是“五行相生链”的乘积（木生火，火生土...）。如果一个区域的五行属性非常均衡且顺畅（例如木火双高），灵气浓度会呈指数级上升，成为“洞天福地”。  
  * 第三部分是“五行相克链”的乘积（木克土，土克水...）。如果一个区域的五行属性非常不均衡（例如木土双高），灵气浓度会呈指数级下降，成为“邪地”。  
  * $\mu$ 是平衡系数（例如 0.5）。

## 第三部分：五行流转（CA 邻域规则）

五种属性在相邻节点间（如 $Z_1 \leftrightarrow Z_6$）传播时，遵循完全不同的规则：  
我们定义 $\Delta E$ 为每个时间步长（Tick）的变化量。设 $Z_i$ 为当前节点，$Z_j$ 为邻居节点。

### **1. 水 (Aqua/Water) - 渗透 (Osmosis)**

* **规则**：传统的扩散逻辑，追求绝对的水平面平衡。  
* **逻辑**：水总是从高处流向低处，填补空缺。  
* 公式：

  $$\Delta a_{i \to j} = k_a \cdot (A_i - A_j)$$

  (若 $A_i > A_j$，则 $i$ 流向 $j$，反之亦然。)

### **2. 火 (Fire) - 蔓延与引燃 (Ignition)**

* **规则**：火具有侵略性。它不看对方的火多不多，而是看对方有没有“燃料”（木）。  
* **逻辑**：如果邻居 $Z_j$ 木属性高，$Z_i$ 的火会“顺着”烧过去，使 $Z_j$ 火属性大增。  
* 公式：

  $$\Delta f_j = k_f \cdot (F_i \times W_j)$$

  (火不会凭空均分，而是寻找燃料扩散。$Z_j$ 的木物质转化为火物质)

### **3. 木 (Wood) - 根系 (Rooting)**

* **规则**：生命寻找生存空间。  
* **逻辑**：木属性会缓慢向周围灵气浓度 ($N$) 高但木属性低的地方生长。  
* 公式：  

   $$\Delta w_j = k_w \cdot (W_i - W_j)$$

  若 $N_j > N_i$ 且 $W_j < W_i$，则木向 $j$ 生长。$Z_j$ 的灵气转化为木物质。

### **4. 金 (Metal) - 聚敛 (Attraction)**

* **规则**：金具有磁性/引力，呈“马太效应”（强者恒强）。  
* **逻辑**：金属性高的地区会从金属性低的相邻地区“掠夺”金气。  
* 公式：  

   $$\Delta m_{j \to i} = k_m \cdot (M_i - M_j)$$

  若 $M_i > M_j$，则 $Z_i$ 从 $Z_j$ 吸取金气。

### **5. 土 (Earth) - 沉积 (Deposition)**

* **规则**：阻滞与同化。  
* **逻辑**：土属性不仅通过均值传播，还会**降低**相邻地区所有属性的流转速度（增加粘性）。土属性越高，该区域与其他区域的交换越迟钝。
* **公式**：

  1. **同化（扩散）公式**：
     $$\Delta e_{i \to j} = k_e \cdot (E_i - E_j)$$
     (土属性自身倾向于在相邻区域间均摊)

  2. **阻滞（粘性）公式**：
     定义阻力系数 $\eta_{ij}$：
     $$\eta_{ij} = \beta \cdot (E_i + E_j)$$
     则该连接路径上所有五行属性的实际流转量 $\Delta X'$ 为：

$$\Delta X'_{i \to j} = \frac{\Delta X_{i \to j}}{1 + \eta_{ij}}$$

(其中 $X \in \{w, f, e, m, a\}$， $\Delta X$ 为规则1-4计算出的原始变化量。 $\beta$ 为粘性系数)

## 第四部分：灵脉与羁绊系统 (Meridian Stability)

为了满足“灵气浓度差异不大形成羁绊”且“阻碍变化”的需求，引入**阻尼系数 (Damping Factor)**。

### **1. 羁绊形成 (Bonding)**

对于相邻的 $Z_i, Z_j$，计算两者的灵气差：

$$\delta = |N_i - N_j|$$

* 如果 $\delta < \text{Threshold}$ (阈值)，则建立/加强羁绊 $B_{ij}$。  
* 羁绊值 $B_{ij}$ 范围为 $[0, 1]$。

### **2. 灵脉判定 (The Meridian)**

当多个连续节点（如 $Z_6 - Z_1 - Z_2 - Z_3$）之间的 $B_{ij}$ 都处于高位时，这条路径在视觉上高亮，被系统判定为 **“灵脉成型”**。

### **3. 稳定性机制 (Resistance)**

羁绊值 $B$ 转化为“变化阻力” $R$。  
在计算下一帧五行变化时，实际生效的变化量会被阻力抵消：

$$\text{FinalChange} = \text{CalculatedChange} \times (1 - \text{Max}(B_{ij}))$$

* **效果**：一旦灵脉形成，内部的灵气流动变得极其微弱，数值被“锁死”在高位或特定状态。外部的普通干扰无法动摇灵脉。

### **4. 衰减与破坏 (Decay & Break)**

灵脉不能永恒，否则游戏会死水一潭。

* **自然衰减**：羁绊值 $B_{ij}$ 每个 Tick 会自动衰减 $1\%$。  
* **五行冲击**：玩家必须制造**极端的五行失衡**来打破灵脉。  
  * *例如*：$Z_1$ 和 $Z_2$ 形成了稳定的灵脉。玩家在 $Z_1$ 疯狂投放“火属性法宝”。  
  * 火属性剧烈上升 $\to$ 导致 $Z_1$ 的 $N$ 值暴涨 $\to$ $|N_1 - N_2|$ 差值瞬间拉大 $\to$ 超过阈值 $\to$ **羁绊断裂 (Bond Broken)**。  
  * 羁绊断裂瞬间，阻力消失，积压的五行变化会像洪水一样爆发（Game Event: 灵气潮汐）。

## 总结：系统循环图 (Game Loop)

每一帧（Tick）的处理流程：

1. **事件输入**：玩家/NPC在 $Z_1$ 种树（木++），在 $Z_4$ 挖矿（金++）。  
2. **五行流转**：  
   * 遍历所有连接线（如 $Z_1-Z_6, Z_1-Z_2$）。  
   * 应用 5 套 CA 规则计算 $\Delta E$。  
3. **阻力应用**：  
   * 检查当前的羁绊值 $B$。  
   * 如果羁绊高，大幅削减 $\Delta E$（灵脉锁灵）。  
4. **状态更新**：  
   * 更新各区五行值 $E$。  
   * 重新计算灵气值 $N$。  
5. **羁绊刷新**：  
   * 根据新的 $N$ 值差，更新羁绊值 $B$（衰减或增强）。  
   * 检测灵脉是否生成或断裂。

## 设计建议 (Next Step)

这个系统可以衍生出很棒的玩法：**“寻龙点穴”** 其实就是寻找图中 $N$ 值高且羁绊稳定的子图；**“斩灵脉”** 就是通过改变某一节点的五行，人为制造巨大的 $\Delta N$，从而破坏系统的稳态。  

### 在五行流转过程中，遵循物质守恒原则

1. 区域内的五行相生循环 (Generating Cycle)：
   * 木生火 (Wood → Fire)：消耗木，增加等真气量的火。如果木为0，则无法产生火。适配CA规则中的火规则。
   * 火生土 (Fire → Earth)：CA规则中的火规则，$\Delta f_j$ 的一部分会转化为土。
   * 土生金 (Earth → Metal)：CA规则中的土规则，$\Delta e_j$ 的一部分会转化为金。
   * 金生水 (Metal → Water)：CA规则中的金规则，$\Delta m_i$ 的一部分会转化为水。
   * 水生木 (Water → Wood)：CA规则中的水规则，$\Delta a_j$ 的一部分会转化为木。

   这样，一个区域内的物质总量是不变的，只是形态在转化。

2. 区域间的流动 (Diffusion)：
   * 某些规则（如火的蔓延）不能凭空增加数值。
   * 基于浓度差的扩散：物质从高浓度区域流向低浓度区域。流出多少，流入多少，总量守恒。

3. 灵脉 (Meridian)作用：
   * 高 bondStrength (灵脉) 会产生阻力，稳定灵气，减少物质的流失/扩散。

### 为了打破均质化（热寂），引入基于五行偏向的结构涌现

1. 数据结构:
   * 为 Zone 增加 bias 属性，表示该区域的五行偏向（地形属性）。

2. 模拟逻辑:
   * 生克规则辅助函数: 定义区域偏好对五行物质的迎克关系（驱逐本区域被克物质，阻碍来自领域的被克物质，同理欢迎相生物质）。
   * 转化 (Generation):
      * 汇聚: 能够产生偏向属性的转化（如水属性区域的金生水），速率加倍。
      * 囤积: 消耗偏向属性的转化（如水属性区域的水生木），速率大幅降低。
   * 扩散 (Diffusion):
      * 滞留: 区域偏向的属性（如水区域的水）流出速度变慢。
      * 驱逐: 被区域偏向所克的属性（如水区域的火）流出速度剧增。
   * 初始化: 随机为区域分配偏向。

### 为了解决系统最终趋于静态热寂的问题，并引入长周期的动态自组织变化，建议引入两个核心机制

1. 天道轮回 (Cosmic Tides/Seasons)：
   * 引入一个全局的时间周期，五行属性会按照“木→火→土→金→水”的顺序轮流增强（得令）。
   * 这类似于“季节”或“运势”。当火运当头时，全地图的火属性生成效率提升，克制关系也会波动。这保证了系统永远有一个外部的驱动力，无法停留在单一的平衡点。

2. 地脉变迁 (Geomantic Shift)：
   * 机制：如果一个区域的“偏向属性”长期被克制它的属性压制（例如：水属性区域内，土属性积累到了水的两倍以上），该区域会发生“沧海桑田”的巨变，其偏向（Bias）会强制转变为那个克制它的属性（水 -> 土）。
   * 涌现效果：这会改变该节点的引流和生成规则，导致连接它的灵脉重新调整，进而在网络中引发连锁反应（雪崩效应）。
